{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-dark text-white py-3">
                <div class="row align-items-center">
                    <div class="col">
                        <h4 class="mb-0"><i class="fas fa-robot me-2"></i>AI Admission Assistant</h4>
                        <p class="mb-0 small">Ask me anything about college admissions, exams, cutoffs, or procedures!</p>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-light" onclick="resetChatHistory()">
                            <i class="fas fa-redo me-1"></i>Reset Chat
                        </button>
                    </div>
                </div>
            </div>

            <div class="chat-container" style="height: 500px;">
                <div class="chat-messages" id="chatMessages" style="height: 380px;">
                    <div class="message bot fade-in">
                        <strong><i class="fas fa-robot me-1"></i>Assistant:</strong><br>
                        Hello! I'm your AI admission assistant. I can help you with:
                        <ul class="mb-0 mt-2 small">
                            <li>Engineering admissions (JEE, CET exams)</li>
                            <li>Medical admissions (NEET)</li>
                            <li>College predictions and cutoffs</li>
                            <li>Admission procedures and counseling</li>
                        </ul>
                        How can I assist you today?
                    </div>
                </div>

                <div class="chat-input border-top bg-light">
                    <div class="p-3">
                        <div class="input-group">
                            <input type="text" id="userInput" class="form-control"
                                   placeholder="Type your question here..."
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-dark" onclick="sendMessage()" id="sendBtn">
                                <i class="fas fa-paper-plane me-1"></i>Send
                            </button>
                        </div>
                        <div class="quick-options mt-2 text-center">
                            <button class="btn btn-sm btn-outline-dark me-1 mb-1" onclick="quickOption('engineering prediction')">
                                <i class="fas fa-cogs me-1"></i>Engineering
                            </button>
                            <button class="btn btn-sm btn-outline-dark me-1 mb-1" onclick="quickOption('medical prediction')">
                                <i class="fas fa-stethoscope me-1"></i>Medical
                            </button>
                            <button class="btn btn-sm btn-outline-dark me-1 mb-1" onclick="quickOption('JEE Main cutoffs')">
                                <i class="fas fa-graduation-cap me-1"></i>JEE Info
                            </button>
                            <button class="btn btn-sm btn-outline-dark me-1 mb-1" onclick="quickOption('NEET cutoffs')">
                                <i class="fas fa-hospital me-1"></i>NEET Info
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: 500px;
}

.chat-messages {
    flex: 1;
    padding: 1.25rem;
    overflow-y: auto;
    background: var(--gray-light);
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.chat-input {
    border-top: 1px solid var(--gray-medium);
    background: var(--light-color);
}

.message {
    padding: 0.8rem 1rem;
    border-radius: 18px;
    font-size: 0.85rem;
    max-width: 85%;
    word-wrap: break-word;
    line-height: 1.4;
    animation: messageSlide 0.2s ease-out;
}

.message.user {
    background: var(--primary-color);
    color: var(--light-color);
    margin-left: auto;
    border-bottom-right-radius: 5px;
}

.message.bot {
    background: var(--light-color);
    border: 1px solid var(--gray-medium);
    margin-right: auto;
    border-bottom-left-radius: 5px;
}
</style>

<script>
// Global variable to store chat context
let chatContext = null;

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function quickOption(option) {
    document.getElementById('userInput').value = option;
    sendMessage();
}

function sendMessage() {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();
    const sendBtn = document.getElementById('sendBtn');

    if (message === '') return;

    // Add user message to chat
    const chatMessages = document.getElementById('chatMessages');
    const userMessageDiv = document.createElement('div');
    userMessageDiv.className = 'message user fade-in';
    userMessageDiv.innerHTML = `<strong><i class="fas fa-user me-1"></i>You:</strong><br>${message}`;
    chatMessages.appendChild(userMessageDiv);

    // Clear input and disable button
    userInput.value = '';
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';

    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot fade-in';
    typingDiv.innerHTML = '<strong><i class="fas fa-robot me-1"></i>Assistant:</strong><br><i class="fas fa-ellipsis-h"></i> Thinking...';
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // Send message to server with context
    fetch('/chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            context: chatContext
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove typing indicator
        chatMessages.removeChild(typingDiv);

        // Add bot response
        const botMessageDiv = document.createElement('div');
        botMessageDiv.className = 'message bot fade-in';

        let responseHTML = `<strong><i class="fas fa-robot me-1"></i>Assistant:</strong><br>${data.response}`;

        // Add options if available
        if (data.options && data.options.length > 0) {
            responseHTML += `<br><div class="mt-2">`;
            data.options.forEach(option => {
                responseHTML += `<button class="btn btn-sm btn-outline-dark me-1 mb-1" onclick="quickOption('${option}')">${option}</button>`;
            });
            responseHTML += `</div>`;
        }

        botMessageDiv.innerHTML = responseHTML;
        chatMessages.appendChild(botMessageDiv);

        // Update context for next message
        if (data.context) {
            chatContext = data.context;
        } else {
            chatContext = null;
        }

        // Re-enable button and scroll to bottom
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => {
        console.error('Chatbot error:', error);
        chatMessages.removeChild(typingDiv);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'message bot fade-in';
        errorDiv.innerHTML = '<strong><i class="fas fa-robot me-1"></i>Assistant:</strong><br>Sorry, I encountered an error. Please try again.';
        chatMessages.appendChild(errorDiv);

        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane me-1"></i>Send';
        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatContext = null; // Reset context on error
    });
}

function resetChatHistory() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = '';

    const welcomeDiv = document.createElement('div');
    welcomeDiv.className = 'message bot fade-in';
    welcomeDiv.innerHTML = `
        <strong><i class="fas fa-robot me-1"></i>Assistant:</strong><br>
        Hello! I'm your AI admission assistant. I can help you with:
        <ul class="mb-0 mt-2 small">
            <li>Engineering admissions (JEE, CET exams)</li>
            <li>Medical admissions (NEET)</li>
            <li>College predictions and cutoffs</li>
            <li>Admission procedures and counseling</li>
        </ul>
        How can I assist you today?
    `;
    chatMessages.appendChild(welcomeDiv);
    chatContext = null;
}

// Initialize chat when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chatbot initialized');
    // Scroll to bottom on load
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
});
</script>
{% endblock %}